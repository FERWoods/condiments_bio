---
title: "Revive the MTME"
author: "Hector Roux de Bézieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{The tradeSeq workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F, 
  fig.align = "center", echo = F
)
```

This is a very rough draft to help clarify the various questions of Differential Topology and Different Gene expression between different topologies. There are two big questions with this condition + lineage analysis.

# Differential Topology


```{r}
library(DifTopo)
set.seed(2071)
```
There are 3 subtypes. Not sure yet how to tell them apart other than visual inspection? 
Ideas from 1.3 could be adapted to be able to tell them apart.

## Same trajectory

This is what was covered in the new slingshot vignette by Kelly and Koen. We have for example this type of topology:

```{r}
sd <- create_differential_topology(n_cells = 200, shift = 0,
                                   unbalance_level = .8)
ggplot(data.frame(sd$rd, cl = sd$cl), aes(x = Dim1, y = Dim2, col = cl)) +
  geom_point() +
  theme_classic() +
  labs(col = "Condition") +
  scale_color_brewer(type = "qual", palette = "Dark2")
```

In that case, we can use pseudotime distribution to see if pseudotime in one of some or all lineages is associated with condition, as is done in the vignette. We need to decide which test works best but there are plenty of options here.

## Same topology, different trajectories

For example, we can have a situation where the intermediate state is different between condition A and B for one lineage. Or it could be the end states.

```{r}
sd <- sd <- create_differential_topology(n_cells = 300, shift = 10,
                                   unbalance_level = .5, noise = .1)
ggplot(data.frame(sd$rd, cl = sd$cl), aes(x = Dim1, y = Dim2, col = cl)) +
  geom_point() +
  theme_classic() +
  labs(col = "Condition") +
  scale_color_brewer(type = "qual", palette = "Dark2")
```

Since most TI methods (at least for the good ones) do not rely on a statistical framework but are purely computational, it's hard to imagine something based on likelihood ratio test for one topology versus two topologies. In that case, we can maybe do a permutation test to see if the conditions are useful info for assigning trajectories. However, as shown in the simulation study of the *tradeSeq* paper, fully unsupervised trajectory inference is far from obvious. Furthermore, a tricky point would be to identify the lineages when we permute: how do we know 1 is 1? We can probably use the cells themselves since in examples like above at least, it is unlikely that the cells would change lineages. Then, their is the question of the metric to use. My current idea would be mean distance to the curve but looking forward to ideas.

## Different topology 

This is actually more common, or at least I have seen a real biology example. For example, in one condition, cells cannot differentiate through one lineage. This is basically the edge case of 1.1.

```{r}
sd <- create_differential_topology(n_cells = 200, shift = 0,
                                   unbalance_level = 1)
ggplot(data.frame(sd$rd, cl = sd$cl), aes(x = Dim1, y = Dim2, col = cl)) +
  geom_point() +
  theme_classic() +
  labs(col = "Condition") +
  scale_color_brewer(type = "qual", palette = "Dark2")
```

In that case, though, the second lineage is unchanged. But we can easily imagine a situation where one lineage changes and the other disappears, an edge case of a) and b):

```{r}
sd <- create_differential_topology(n_cells = 300, shift = 10,
                                   unbalance_level = 1, noise = .1)
ggplot(data.frame(sd$rd, cl = sd$cl), aes(x = Dim1, y = Dim2, col = cl)) +
  geom_point() +
  theme_classic() +
  labs(col = "Condition") +
  scale_color_brewer(type = "qual", palette = "Dark2")
```

If we can tell them apart (not sure how but maybe we can punt, at least for now), the edge case of a) can fall under the umbrella of a) itself in term of testing. Then, all the solutions in the vignette, 

For the edge case of b) (and in general maybe to tell the cases apart), we could forgo the trajectories when doing differential topology. I think a test like Moran’ I test (used in Monocle 3) would actually be very appropriate.

# Differential Gene Expression.

Once we have found the correct topology, gene DE should be quite straightforward using the *tradeSeq* framework, and Koen already did some great work there!!
I think the main task would be coding a flexible enough framework so that it encompasses cases from a, b and c above without having 200 different functions.
